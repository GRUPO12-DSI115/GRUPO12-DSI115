{% extends 'inicio/base2.html' %}
{% block breadcrumb %}
  <li class="breadcrumb-item">
    <a href="/">Inicio</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page"><a href="{% url 'moduloGestionConsultas:lista_consultas' %}">Lista de Consultas</a></li>
  <li class="breadcrumb-item active" aria-current="page">Editar consulta</li>
{% endblock %}
{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div class="text-center mb-4">
        <h1>Editar Consulta</h1>
      </div>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {% if consulta_form.errors %}
        <div class="alert alert-danger">
          <h5>Por favor, corrija los siguientes errores:</h5>
          <ul>
            {% for field, error_list in consulta_form.errors.items %}
            {% for error in error_list %}
            <li>{{ field|title }}: {{ error }}</li>
            {% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">Datos de la Consulta</div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label for="tipo_consulta">Tipo de consulta:</label>
                  <input id="tipo_consulta" name="tipo_consulta" class="form-control" value="{{ consulta.tipo_consulta }}" required />
                </div>
                <div class="form-group mb-3">
                  <label for="motivo">Motivo:</label>
                  <textarea id="motivo" name="motivo" class="form-control" required>{{ consulta.motivo }}</textarea>
                </div>
                <div class="form-group mb-3">
                  <label for="diagnostico">Diagn√≥stico:</label>
                  <textarea id="diagnostico" name="diagnostico" class="form-control" required>{{ consulta.diagnostico }}</textarea>
                </div>                
                <div class="form-group mb-3">
                  <label for="expediente">Expediente:</label>
                  <select id="expediente" name="expediente" class="form-control" required>
                    <option value="">Seleccione un expediente</option>
                    {% for expediente in expedientes %}
                    {% if expediente.pk == consulta.expediente.pk %}
                    <option value="{{ expediente.pk }}" selected>{{ expediente }}</option>
                    {% else %}
                    <option value="{{ expediente.pk }}">{{ expediente }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group mb-3">
                  <label for="veterinario">Veterinario:</label>
                  <select id="veterinario" name="veterinario" class="form-control" required>
                    <option value="">Seleccione un veterinario</option>
                    {% for veterinario in veterinarios %}
                    {% if veterinario.pk == consulta.veterinario.pk %}
                    <option value="{{ veterinario.pk }}" selected>{{ veterinario }}</option>
                    {% else %}
                    <option value="{{ veterinario.pk }}">{{ veterinario }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">Medicamentos Utilizados</div>
              <div class="card-body" id="medicamentos-section">
                {% for consulta_medicamento in consulta.consultamedicamento_set.all %}
                <div class="medicamento-group">
                  <div class="form-group mb-3">
                    <label for="medicamento_{{ consulta_medicamento.pk }}">Medicamento:</label>
                    <select id="medicamento_{{ consulta_medicamento.pk }}" name="medicamento_{{ consulta_medicamento.pk }}" class="form-control">
                      <option value="">Seleccione un medicamento</option>
                      {% for medicamento in medicamentos %}
                      <option value="{{ medicamento.pk }}" {% if consulta_medicamento.medicamento.pk == medicamento.pk %} selected {% endif %}>{{ medicamento }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-group mb-3">
                    <label for="cantidad_{{ consulta_medicamento.pk }}">Cantidad Utilizada:</label>
                    <input id="cantidad_{{ consulta_medicamento.pk }}" name="cantidad_{{ consulta_medicamento.pk }}" class="form-control" type="number" min="1" value="{{ consulta_medicamento.cantidad_utilizada }}" />
                  </div>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-success" id="agregar-medicamento">Agregar Medicamento</button>
            </div>
          </div>
        </div>
        <div class="text-center mt-3">
          <a href="{% url 'moduloGestionConsultas:lista_consultas' %}" class="btn btn-secondary btn-sm">Cancelar</a>
          <button type="submit" class="btn btn-primary btn-sm">Guardar Consulta</button>
        </div>
      </form>
    </div>
  </div>
</div>
<br />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    var contador = {{ consulta.consultamedicamento_set.all|length }};
    $('#agregar-medicamento').click(function() {
      contador++;
      var nuevoMedicamento = `
        <div class="medicamento-group">
          <div class="form-group mb-3">
            <label for="medicamento_${contador}">Medicamento:</label>
            <select id="medicamento_${contador}" name="medicamento_${contador}" class="form-control">
              <option value="">Seleccione un medicamento</option>
              {% for medicamento in medicamentos %}
              <option value="{{ medicamento.pk }}">{{ medicamento }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mb-3">
            <label for="cantidad_${contador}">Cantidad Utilizada:</label>
            <input id="cantidad_${contador}" name="cantidad_${contador}" class="form-control" type="number" min="1" />
          </div>
        </div>
      `;
      $('#medicamentos-section').append(nuevoMedicamento);
    });
  });
</script>
{% endblock %}
